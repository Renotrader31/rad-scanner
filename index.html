<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAD Scanner - Resistance After Dip</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a25;
            --bg-card: #15151f;
            --border-color: #2a2a3a;
            --text-primary: #e8e8ef;
            --text-secondary: #8888a0;
            --text-muted: #555566;
            --accent-bullish: #00d4aa;
            --accent-bullish-dim: rgba(0, 212, 170, 0.15);
            --accent-bearish: #ff4d6a;
            --accent-bearish-dim: rgba(255, 77, 106, 0.15);
            --accent-neutral: #6677aa;
            --accent-neutral-dim: rgba(102, 119, 170, 0.15);
            --accent-warning: #ffaa00;
            --accent-info: #4d9fff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo {
            font-family: 'JetBrains Mono', monospace;
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-bullish), var(--accent-info));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .badge {
            background: var(--accent-info);
            color: var(--bg-primary);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .last-scan {
            font-size: 13px;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 20px;
            margin-bottom: 28px;
            padding: 20px;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-group label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-group input,
        .control-group select {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 14px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: 'JetBrains Mono', monospace;
            transition: all 0.2s ease;
        }

        .control-group input:focus,
        .control-group select:focus {
            outline: none;
            border-color: var(--accent-info);
            box-shadow: 0 0 0 3px rgba(77, 159, 255, 0.15);
        }

        .control-group input::placeholder {
            color: var(--text-muted);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Inter', sans-serif;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-bullish), #00b894);
            color: var(--bg-primary);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 212, 170, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
            margin-bottom: 28px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 18px 20px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .stat-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 24px;
            font-weight: 700;
        }

        .stat-value.bullish { color: var(--accent-bullish); }
        .stat-value.bearish { color: var(--accent-bearish); }
        .stat-value.neutral { color: var(--text-secondary); }

        .filters {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 18px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-btn:hover {
            border-color: var(--text-muted);
            color: var(--text-primary);
        }

        .filter-btn.active {
            background: var(--accent-info);
            border-color: var(--accent-info);
            color: var(--bg-primary);
        }

        .filter-btn.bullish.active {
            background: var(--accent-bullish);
            border-color: var(--accent-bullish);
        }

        .filter-btn.bearish.active {
            background: var(--accent-bearish);
            border-color: var(--accent-bearish);
        }

        .results-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .results-title {
            font-size: 16px;
            font-weight: 600;
        }

        .results-count {
            font-size: 13px;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--bg-tertiary);
        }

        th {
            padding: 14px 18px;
            text-align: left;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-color);
        }

        th.sortable {
            cursor: pointer;
            user-select: none;
        }

        th.sortable:hover {
            color: var(--text-secondary);
        }

        th.sortable.sorted {
            color: var(--accent-info);
        }

        td {
            padding: 16px 18px;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }

        tbody tr {
            transition: background 0.15s ease;
        }

        tbody tr:hover {
            background: var(--bg-tertiary);
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .ticker-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .ticker-symbol {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 15px;
            color: var(--accent-info);
        }

        .price-cell {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
        }

        .change-cell {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
        }

        .change-cell.positive { color: var(--accent-bullish); }
        .change-cell.negative { color: var(--accent-bearish); }

        .signal-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .signal-badge.bullish {
            background: var(--accent-bullish-dim);
            color: var(--accent-bullish);
        }

        .signal-badge.bearish {
            background: var(--accent-bearish-dim);
            color: var(--accent-bearish);
        }

        .signal-badge.neutral {
            background: var(--accent-neutral-dim);
            color: var(--accent-neutral);
        }

        .score-cell {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
        }

        .score-cell.high { color: var(--accent-bullish); }
        .score-cell.low { color: var(--accent-bearish); }
        .score-cell.medium { color: var(--accent-warning); }

        .trend-cell {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .trend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .trend-dot.up { background: var(--accent-bullish); }
        .trend-dot.down { background: var(--accent-bearish); }

        .action-btn {
            padding: 8px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            background: var(--accent-info);
            border-color: var(--accent-info);
            color: var(--bg-primary);
        }

        .loading-state,
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 80px 40px;
            color: var(--text-muted);
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-info);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 15px;
            margin-bottom: 8px;
        }

        .empty-hint {
            font-size: 13px;
            color: var(--text-muted);
        }

        .progress-container {
            margin-top: 16px;
            width: 300px;
        }

        .progress-bar {
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-info), var(--accent-bullish));
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 8px;
            font-family: 'JetBrains Mono', monospace;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 28px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .settings-group {
            margin-bottom: 24px;
        }

        .settings-group-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 14px;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-row:last-child {
            border-bottom: none;
        }

        .settings-label {
            font-size: 14px;
        }

        .settings-input {
            width: 100px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px 12px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            text-align: right;
        }

        @media (max-width: 1200px) {
            .stats-bar {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .controls {
                grid-template-columns: 1fr;
            }
            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }
            .header {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-left">
                <div class="logo">RAD Scanner</div>
                <span class="badge">Daily</span>
            </div>
            <div class="header-right">
                <span class="last-scan" id="lastScan">Last scan: --</span>
                <button class="btn btn-secondary" onclick="openSettings()">‚öôÔ∏è Settings</button>
            </div>
        </header>

        <div class="controls">
            <div class="control-group">
                <label>Polygon API Key</label>
                <input type="password" id="apiKey" placeholder="Enter your Polygon API key" />
            </div>
            <div class="control-group">
                <label>Watchlist</label>
                <select id="watchlist">
                    <option value="sp500">S&P 500</option>
                    <option value="nasdaq100">NASDAQ 100</option>
                    <option value="russell2000">Russell 2000 (Top 200)</option>
                    <option value="custom">Custom Tickers</option>
                </select>
            </div>
            <div class="control-group" style="justify-content: flex-end;">
                <button class="btn btn-primary" id="scanBtn" onclick="runScan()">
                    üîç Run RAD Scan
                </button>
            </div>
        </div>

        <div class="controls" id="customTickersContainer" style="display: none; margin-top: -12px;">
            <div class="control-group" style="grid-column: span 3;">
                <label>Custom Tickers (comma separated)</label>
                <input type="text" id="customTickers" placeholder="AAPL, MSFT, GOOGL, TSLA, NVDA..." />
            </div>
        </div>

        <div class="stats-bar">
            <div class="stat-card">
                <span class="stat-label">Total Scanned</span>
                <span class="stat-value neutral" id="statTotal">0</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Bullish Setups</span>
                <span class="stat-value bullish" id="statBullish">0</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Bearish Setups</span>
                <span class="stat-value bearish" id="statBearish">0</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Avg Score</span>
                <span class="stat-value neutral" id="statAvgScore">--</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">High Conviction</span>
                <span class="stat-value bullish" id="statHighConviction">0</span>
            </div>
        </div>

        <div class="filters">
            <button class="filter-btn active" data-filter="all" onclick="filterResults('all')">All Signals</button>
            <button class="filter-btn bullish" data-filter="bullish" onclick="filterResults('bullish')">Bullish Only</button>
            <button class="filter-btn bearish" data-filter="bearish" onclick="filterResults('bearish')">Bearish Only</button>
            <button class="filter-btn" data-filter="highscore" onclick="filterResults('highscore')">High Score (¬±4+)</button>
        </div>

        <div class="results-container">
            <div class="results-header">
                <span class="results-title">RAD Signals</span>
                <span class="results-count" id="resultsCount">0 results</span>
            </div>
            
            <div id="loadingState" class="loading-state" style="display: none;">
                <div class="loading-spinner"></div>
                <span>Scanning for RAD setups...</span>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    <div class="progress-text" id="progressText">0 / 0 tickers</div>
                </div>
            </div>

            <div id="emptyState" class="empty-state">
                <div class="empty-icon">üìä</div>
                <div class="empty-text">No scan results yet</div>
                <div class="empty-hint">Enter your API key and click "Run RAD Scan" to find setups</div>
            </div>

            <table id="resultsTable" style="display: none;">
                <thead>
                    <tr>
                        <th class="sortable" onclick="sortResults('ticker')">Ticker</th>
                        <th class="sortable" onclick="sortResults('price')">Price</th>
                        <th class="sortable" onclick="sortResults('change')">Change %</th>
                        <th class="sortable sorted" onclick="sortResults('score')">RAD Score</th>
                        <th>Signal</th>
                        <th class="sortable" onclick="sortResults('trend')">Trend</th>
                        <th>Dip %</th>
                        <th>Consol Range</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="resultsBody">
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Scanner Settings</span>
                <button class="modal-close" onclick="closeSettings()">&times;</button>
            </div>
            
            <div class="settings-group">
                <div class="settings-group-title">Dip Detection</div>
                <div class="settings-row">
                    <span class="settings-label">ATR Multiplier</span>
                    <input type="number" class="settings-input" id="settingAtrMult" value="1.8" step="0.1" min="0.5" max="5" />
                </div>
                <div class="settings-row">
                    <span class="settings-label">Lookback Period (days)</span>
                    <input type="number" class="settings-input" id="settingLookback" value="20" min="5" max="60" />
                </div>
            </div>

            <div class="settings-group">
                <div class="settings-group-title">Consolidation Analysis</div>
                <div class="settings-row">
                    <span class="settings-label">Consolidation Window (days)</span>
                    <input type="number" class="settings-input" id="settingConsolDays" value="5" min="2" max="15" />
                </div>
                <div class="settings-row">
                    <span class="settings-label">Range Contraction Threshold</span>
                    <input type="number" class="settings-input" id="settingRangeThresh" value="0.7" step="0.05" min="0.3" max="1" />
                </div>
            </div>

            <div class="settings-group">
                <div class="settings-group-title">Signal Thresholds</div>
                <div class="settings-row">
                    <span class="settings-label">Bullish Score Threshold</span>
                    <input type="number" class="settings-input" id="settingBullThresh" value="3.0" step="0.5" min="1" max="8" />
                </div>
                <div class="settings-row">
                    <span class="settings-label">Bearish Score Threshold</span>
                    <input type="number" class="settings-input" id="settingBearThresh" value="-2.0" step="0.5" min="-8" max="-0.5" />
                </div>
            </div>

            <div class="settings-group">
                <div class="settings-group-title">Trend Filter</div>
                <div class="settings-row">
                    <span class="settings-label">EMA Length (days)</span>
                    <input type="number" class="settings-input" id="settingEmaLength" value="50" min="10" max="200" />
                </div>
            </div>

            <button class="btn btn-primary" style="width: 100%; margin-top: 12px;" onclick="saveSettings()">Save Settings</button>
        </div>
    </div>

    <script>
        const WATCHLISTS = {
            sp500: ['AAPL','MSFT','AMZN','NVDA','GOOGL','META','TSLA','BRK.B','UNH','XOM','JNJ','JPM','V','PG','MA','HD','CVX','MRK','ABBV','LLY','PEP','KO','AVGO','COST','TMO','MCD','WMT','CSCO','ACN','ABT','DHR','CRM','NKE','NEE','LIN','TXN','PM','BMY','UNP','RTX','ORCL','HON','QCOM','UPS','LOW','IBM','INTC','SPGI','CAT','GS','BA','AMD','SBUX','DE','AXP','ELV','MDLZ','ISRG','BLK','GILD','PLD','ADI','REGN','VRTX','SYK','BKNG','MMC','CVS','TMUS','CI','ZTS','C','CB','SO','DUK','MO','PNC','TJX','SCHW','CL','ICE','BDX','EOG','CME','ITW','CCI','SLB','APD','NOC','FDX','WM','EMR','ETN','HUM','NSC','MCO','ORLY','PXD','KLAC','ADP','PSA','MPC','GD','ANET','LRCX','D','MNST','SRE','SNPS','F','ADSK','GM','AEP','MCHP','PAYX','TGT','ROP','JCI','O','KMB','AZO','CHTR','TRV','HES','TEL','MET','MSCI','CTVA','EW','SHW','PCG','AIG','KHC','HSY','WELL','IDXX','SPG','AFL','OXY','DXCM','A','BIIB','ALL','CTAS','MAR','WMB','DLR','CMI','PCAR','KDP','PRU','FTNT','DOW','EXC','LHX','YUM','AME','IQV','NUE','GIS','HLT','ROST','STZ','ON','ODFL','FANG','GEHC','ED','CPRT','FAST','CDW','XEL','CNC','OTIS','EIX','VRSK','HPQ','MTD','AWK','KEYS','RSG','ANSS','VICI','DVN','GLW','DD','GPN','PPG','WEC','TROW','FTV','WTW','DFS','ES','BKR','DAL','EFX','FIS','SBAC','ULTA','EBAY','URI','WAB','TTWO','ABC','VMC','CHD','HAL','PEG','ALGN','ACGL','WST','RMD','EQR','BRO','CBRE','PWR','TSCO','IR','HOLX','WBA','LUV','MLM','AVB','ZBH','LEN','APTV','MTB','CAH','K','FE','AMP','FLT','VRSN','RF','STE','OMC','LYB','TSN','DTE','IP','GPC','MOH','ARE','PPL','EXPE','AJG','AXON','FITB','CFG','HPE','XYL','DG','VTR','TRGP','CE','MAA','BR','ETR','NTAP','TDY','EXPD','HIG','IFF','DOV','TER','NVR','INVH','MGM','DLTR','SWKS','AMCR','WAT','NDAQ','DPZ','UAL','SJM','CLX','J','NRG','BALL','ZBRA','KEY','CAG','TXT','CNP','ATO','CINF','EQT','CRL','PHM','SYF','SWK','FSLR','ESS','COO','BXP','UDR','FICO','JBHT','MAS','PNR','WRB','IEX','FMC','DRI','LNT','CHRW','AKAM','LDOS','PAYC','KIM','TECH','EVRG','BBY','BIO','APA','CPT','LKQ','PKI','TYL','STT','NI','MKC','L','IPG','HRL','HSIC','JKHY','TPR','NDSN','AES','REG','WYNN','POOL','MTCH','RCL','CCL','QRVO','GL','ROL','PEAK','RE','BEN','BWA','CBOE','CZR','HWM','CPB','WHR','SEE','EMN','FRT','CDAY','HII','MKTX','BBWI','GNRC','AIZ','AAL','PNW','NWL','XRAY','AAP','IVZ','CMA','ALLE','VFC','ALB','ETSY','FFIV','PFG','LW','ZION','PARA','DXC','DISH','FOX','FOXA','NWS','NWSA'],
            nasdaq100: ['AAPL','MSFT','AMZN','NVDA','META','TSLA','GOOGL','GOOG','AVGO','COST','PEP','CSCO','ADBE','NFLX','AMD','CMCSA','TMUS','INTC','INTU','TXN','QCOM','AMGN','HON','AMAT','BKNG','ISRG','SBUX','VRTX','ADP','GILD','MDLZ','LRCX','ADI','REGN','PYPL','KLAC','SNPS','PANW','MNST','CDNS','MELI','NXPI','ORLY','MAR','ASML','CTAS','CRWD','MRVL','FTNT','ABNB','KDP','PAYX','PCAR','DXCM','CHTR','WDAY','ROST','AEP','ODFL','CPRT','AZN','IDXX','GEHC','ON','EXC','FAST','BIIB','CEG','FANG','VRSK','KHC','CSGP','CTSH','XEL','EA','ANSS','BKR','DLTR','DDOG','GFS','WBD','ALGN','ZS','TTWO','LCID','EBAY','ZM','ENPH','SIRI','JD','RIVN','TEAM','MRNA'],
            russell2000: ['AMC','GME','SPCE','PLTR','SOFI','LCID','RIVN','PLUG','FCEL','NKLA','WISH','CLOV','BB','NOK','OPEN','UWMC','RKT','SKLZ','BNGO','SENS','MVIS','WKHS','RIDE','GOEV','FSR','BLNK','CHPT','QS','LAZR','RIOT','MARA','HUT','BITF','CLSK','CORZ','IREN','BTBT','ARBK','BKKT','COIN','SI','WAL','PACW','ZION','CMA','KEY','RF','FITB','CFG','HBAN','TFC','MTB','ALLY','COF','DFS','SYF','NAVI','FCNCA','AX','HWC','FHN','ONB','PNFP','IBKR','SCHW','VIRT','HOOD','DASH','ABNB','LYFT','UBER','GRAB','SE','SHOP','MELI','ETSY','CPNG','PDD','BABA','JD','BILI','TME','BIDU','NIO','XPEV','LI']
        };

        let scanResults = [];
        let filteredResults = [];
        let currentSort = { column: 'score', direction: 'desc' };
        let currentFilter = 'all';
        let settings = {
            atrMult: 1.8,
            lookback: 20,
            consolDays: 5,
            rangeThresh: 0.7,
            bullThresh: 3.0,
            bearThresh: -2.0,
            emaLength: 50
        };

        document.addEventListener('DOMContentLoaded', () => {
            const savedKey = localStorage.getItem('polygonApiKey');
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
            }
            const savedSettings = localStorage.getItem('radScannerSettings');
            if (savedSettings) {
                settings = { ...settings, ...JSON.parse(savedSettings) };
                applySettingsToUI();
            }
            document.getElementById('watchlist').addEventListener('change', (e) => {
                document.getElementById('customTickersContainer').style.display = 
                    e.target.value === 'custom' ? 'block' : 'none';
            });
        });

        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function applySettingsToUI() {
            document.getElementById('settingAtrMult').value = settings.atrMult;
            document.getElementById('settingLookback').value = settings.lookback;
            document.getElementById('settingConsolDays').value = settings.consolDays;
            document.getElementById('settingRangeThresh').value = settings.rangeThresh;
            document.getElementById('settingBullThresh').value = settings.bullThresh;
            document.getElementById('settingBearThresh').value = settings.bearThresh;
            document.getElementById('settingEmaLength').value = settings.emaLength;
        }

        function saveSettings() {
            settings = {
                atrMult: parseFloat(document.getElementById('settingAtrMult').value),
                lookback: parseInt(document.getElementById('settingLookback').value),
                consolDays: parseInt(document.getElementById('settingConsolDays').value),
                rangeThresh: parseFloat(document.getElementById('settingRangeThresh').value),
                bullThresh: parseFloat(document.getElementById('settingBullThresh').value),
                bearThresh: parseFloat(document.getElementById('settingBearThresh').value),
                emaLength: parseInt(document.getElementById('settingEmaLength').value)
            };
            localStorage.setItem('radScannerSettings', JSON.stringify(settings));
            closeSettings();
        }

        async function fetchDailyBars(ticker, apiKey, days = 60) {
            const endDate = new Date().toISOString().split('T')[0];
            const startDate = new Date(Date.now() - days * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            const url = `https://api.polygon.io/v2/aggs/ticker/${ticker}/range/1/day/${startDate}/${endDate}?adjusted=true&sort=asc&apiKey=${apiKey}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.results && data.results.length > 0) {
                    return data.results.map(bar => ({
                        date: new Date(bar.t),
                        open: bar.o,
                        high: bar.h,
                        low: bar.l,
                        close: bar.c,
                        volume: bar.v
                    }));
                }
                return null;
            } catch (error) {
                console.error(`Error fetching ${ticker}:`, error);
                return null;
            }
        }

        function calculateATR(bars, period = 14) {
            if (bars.length < period + 1) return null;
            let trSum = 0;
            for (let i = 1; i <= period; i++) {
                const idx = bars.length - 1 - (period - i);
                const high = bars[idx].high;
                const low = bars[idx].low;
                const prevClose = bars[idx - 1].close;
                const tr = Math.max(high - low, Math.abs(high - prevClose), Math.abs(low - prevClose));
                trSum += tr;
            }
            return trSum / period;
        }

        function calculateEMA(bars, period) {
            if (bars.length < period) return null;
            const multiplier = 2 / (period + 1);
            let ema = bars.slice(0, period).reduce((sum, bar) => sum + bar.close, 0) / period;
            for (let i = period; i < bars.length; i++) {
                ema = (bars[i].close - ema) * multiplier + ema;
            }
            return ema;
        }

        function analyzeRAD(bars, ticker) {
            if (!bars || bars.length < settings.lookback + settings.consolDays + 14) {
                return null;
            }
            const atr = calculateATR(bars, 14);
            const ema = calculateEMA(bars, settings.emaLength);
            const currentPrice = bars[bars.length - 1].close;
            const isAboveTrend = currentPrice > ema;

            const lookbackBars = bars.slice(-settings.lookback - settings.consolDays, -settings.consolDays);
            let swingHighIdx = 0;
            let swingHigh = lookbackBars[0].high;
            for (let i = 1; i < lookbackBars.length; i++) {
                if (lookbackBars[i].high > swingHigh) {
                    swingHigh = lookbackBars[i].high;
                    swingHighIdx = i;
                }
            }

            let dipLow = Infinity;
            for (let i = swingHighIdx + 1; i < lookbackBars.length; i++) {
                if (lookbackBars[i].low < dipLow) {
                    dipLow = lookbackBars[i].low;
                }
            }

            const dipMagnitude = swingHigh - dipLow;
            const dipThreshold = atr * settings.atrMult;
            if (dipMagnitude < dipThreshold) {
                return null;
            }

            const consolBars = bars.slice(-settings.consolDays);
            let consolHigh = -Infinity;
            let consolLow = Infinity;
            let higherLowCount = 0;
            let lowerHighCount = 0;
            
            for (let i = 0; i < consolBars.length; i++) {
                consolHigh = Math.max(consolHigh, consolBars[i].high);
                consolLow = Math.min(consolLow, consolBars[i].low);
                if (i > 0) {
                    if (consolBars[i].low > consolBars[i - 1].low) higherLowCount++;
                    if (consolBars[i].high < consolBars[i - 1].high) lowerHighCount++;
                }
            }

            const consolRange = consolHigh - consolLow;
            const rangeRatio = consolRange / dipMagnitude;
            let score = 0;

            if (rangeRatio <= settings.rangeThresh) {
                score += 2.0;
            } else if (rangeRatio <= 1.0) {
                score += 1.0;
            } else {
                score -= 1.0;
            }

            if (higherLowCount >= 2) {
                score += 2.0;
            } else if (higherLowCount >= 1) {
                score += 1.0;
            }

            if (lowerHighCount >= 2) {
                score -= 2.0;
            } else if (lowerHighCount >= 1) {
                score -= 0.5;
            }

            if (consolLow > dipLow) {
                score += 1.5;
            } else if (currentPrice < dipLow) {
                score -= 2.0;
            }

            const avgVolConsol = consolBars.reduce((sum, bar) => sum + bar.volume, 0) / consolBars.length;
            const avgVolPre = lookbackBars.slice(-settings.consolDays).reduce((sum, bar) => sum + bar.volume, 0) / settings.consolDays;
            const volRatio = avgVolConsol / avgVolPre;
            
            if (volRatio < 0.8) {
                score += 1.0;
            } else if (volRatio > 1.2) {
                score -= 0.5;
            }

            let signal = 'NEUTRAL';
            if (score >= settings.bullThresh) {
                signal = 'BULLISH';
            } else if (score <= settings.bearThresh) {
                signal = 'BEARISH';
            }

            let filtered = false;
            if (signal === 'BULLISH' && !isAboveTrend) {
                filtered = true;
            } else if (signal === 'BEARISH' && isAboveTrend) {
                filtered = true;
            }

            if (signal === 'NEUTRAL' || filtered) {
                return null;
            }

            const prevClose = bars[bars.length - 2].close;
            const changePercent = ((currentPrice - prevClose) / prevClose) * 100;
            const dipPercent = ((swingHigh - dipLow) / swingHigh) * 100;

            return {
                ticker,
                price: currentPrice,
                changePercent,
                score,
                signal,
                trend: isAboveTrend ? 'UP' : 'DOWN',
                dipPercent,
                consolRange: ((consolRange / currentPrice) * 100).toFixed(2),
                higherLows: higherLowCount,
                lowerHighs: lowerHighCount,
                ema
            };
        }

        async function runScan() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                alert('Please enter your Polygon API key');
                return;
            }
            localStorage.setItem('polygonApiKey', apiKey);

            const watchlistSelect = document.getElementById('watchlist').value;
            let tickers;
            if (watchlistSelect === 'custom') {
                const customInput = document.getElementById('customTickers').value.trim();
                if (!customInput) {
                    alert('Please enter custom tickers');
                    return;
                }
                tickers = customInput.split(',').map(t => t.trim().toUpperCase()).filter(t => t);
            } else {
                tickers = WATCHLISTS[watchlistSelect] || [];
            }

            if (tickers.length === 0) {
                alert('No tickers to scan');
                return;
            }

            document.getElementById('loadingState').style.display = 'flex';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('resultsTable').style.display = 'none';
            document.getElementById('scanBtn').disabled = true;

            scanResults = [];
            let processed = 0;
            const batchSize = 5;
            const delayBetweenBatches = 1200;

            for (let i = 0; i < tickers.length; i += batchSize) {
                const batch = tickers.slice(i, i + batchSize);
                const promises = batch.map(async (ticker) => {
                    const bars = await fetchDailyBars(ticker, apiKey);
                    if (bars) {
                        const result = analyzeRAD(bars, ticker);
                        if (result) {
                            scanResults.push(result);
                        }
                    }
                    processed++;
                    updateProgress(processed, tickers.length);
                });
                await Promise.all(promises);
                if (i + batchSize < tickers.length) {
                    await new Promise(resolve => setTimeout(resolve, delayBetweenBatches));
                }
            }

            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('scanBtn').disabled = false;
            document.getElementById('lastScan').textContent = `Last scan: ${new Date().toLocaleTimeString()}`;

            sortResults('score');
            updateStats();
            displayResults();
        }

        function updateProgress(current, total) {
            const percent = Math.round((current / total) * 100);
            document.getElementById('progressFill').style.width = `${percent}%`;
            document.getElementById('progressText').textContent = `${current} / ${total} tickers`;
        }

        function updateStats() {
            const bullish = scanResults.filter(r => r.signal === 'BULLISH').length;
            const bearish = scanResults.filter(r => r.signal === 'BEARISH').length;
            const highConviction = scanResults.filter(r => Math.abs(r.score) >= 4).length;
            const avgScore = scanResults.length > 0 
                ? (scanResults.reduce((sum, r) => sum + r.score, 0) / scanResults.length).toFixed(1)
                : '--';

            document.getElementById('statTotal').textContent = scanResults.length;
            document.getElementById('statBullish').textContent = bullish;
            document.getElementById('statBearish').textContent = bearish;
            document.getElementById('statAvgScore').textContent = avgScore;
            document.getElementById('statHighConviction').textContent = highConviction;
        }

        function filterResults(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === filter) {
                    btn.classList.add('active');
                }
            });
            displayResults();
        }

        function sortResults(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = column === 'ticker' ? 'asc' : 'desc';
            }
            document.querySelectorAll('th.sortable').forEach(th => th.classList.remove('sorted'));
            event?.target?.classList?.add('sorted');
            displayResults();
        }

        function displayResults() {
            filteredResults = scanResults.filter(r => {
                if (currentFilter === 'all') return true;
                if (currentFilter === 'bullish') return r.signal === 'BULLISH';
                if (currentFilter === 'bearish') return r.signal === 'BEARISH';
                if (currentFilter === 'highscore') return Math.abs(r.score) >= 4;
                return true;
            });

            filteredResults.sort((a, b) => {
                let aVal, bVal;
                switch (currentSort.column) {
                    case 'ticker': aVal = a.ticker; bVal = b.ticker; break;
                    case 'price': aVal = a.price; bVal = b.price; break;
                    case 'change': aVal = a.changePercent; bVal = b.changePercent; break;
                    case 'score': aVal = a.score; bVal = b.score; break;
                    case 'trend': aVal = a.trend; bVal = b.trend; break;
                    default: aVal = a.score; bVal = b.score;
                }
                if (typeof aVal === 'string') {
                    return currentSort.direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                }
                return currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
            });

            document.getElementById('resultsCount').textContent = `${filteredResults.length} results`;

            if (filteredResults.length === 0) {
                document.getElementById('resultsTable').style.display = 'none';
                document.getElementById('emptyState').style.display = 'flex';
                document.querySelector('.empty-text').textContent = scanResults.length > 0 
                    ? 'No results match current filter' 
                    : 'No RAD setups found';
                return;
            }

            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('resultsTable').style.display = 'table';

            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = filteredResults.map(r => `
                <tr>
                    <td>
                        <div class="ticker-cell">
                            <span class="ticker-symbol">${r.ticker}</span>
                        </div>
                    </td>
                    <td class="price-cell">$${r.price.toFixed(2)}</td>
                    <td class="change-cell ${r.changePercent >= 0 ? 'positive' : 'negative'}">
                        ${r.changePercent >= 0 ? '+' : ''}${r.changePercent.toFixed(2)}%
                    </td>
                    <td class="score-cell ${Math.abs(r.score) >= 4 ? 'high' : Math.abs(r.score) >= 2 ? 'medium' : ''}">
                        ${r.score >= 0 ? '+' : ''}${r.score.toFixed(1)}
                    </td>
                    <td>
                        <span class="signal-badge ${r.signal.toLowerCase()}">${r.signal}</span>
                    </td>
                    <td>
                        <div class="trend-cell">
                            <span class="trend-dot ${r.trend.toLowerCase()}"></span>
                            ${r.trend}
                        </div>
                    </td>
                    <td>${r.dipPercent.toFixed(1)}%</td>
                    <td>${r.consolRange}%</td>
                    <td>
                        <button class="action-btn" onclick="openChart('${r.ticker}')">Chart</button>
                    </td>
                </tr>
            `).join('');
        }

        function openChart(ticker) {
            window.open(`https://www.tradingview.com/chart/?symbol=${ticker}`, '_blank');
        }
    </script>
</body>
</html>
